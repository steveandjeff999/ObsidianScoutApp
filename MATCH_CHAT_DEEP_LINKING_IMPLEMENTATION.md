# ?? Match & Chat Notification Deep Linking - Complete Implementation

## ?? Issues to Fix

1. **Chat notifications don't navigate to ChatPage** - Need better logging to diagnose
2. **Match notifications should navigate to MatchesPage** - Need to add deep link data

---

## ?? Required Changes

### 1. Add EventId to PastNotification Model

**File:** `ObsidianScout/Models/NotificationModels.cs`

```csharp
public class PastNotification
{
    [JsonPropertyName("id")] public int Id { get; set; }
    [JsonPropertyName("subscription_id")] public int SubscriptionId { get; set; }
    [JsonPropertyName("notification_type")] public string NotificationType { get; set; } = string.Empty;
    [JsonPropertyName("match_id")] public int? MatchId { get; set; }
    [JsonPropertyName("match_number")] public int? MatchNumber { get; set; }
    [JsonPropertyName("event_id")] public int? EventId { get; set; }  // ? ADD THIS
    [JsonPropertyName("event_code")] public string? EventCode { get; set; }
  // ... rest of properties
}
```

### 2. Add Deep Link Data to Match Notifications

**File:** `ObsidianScout/Services/BackgroundNotificationService.cs`

**In `ShowNotificationAsync(ScheduledNotification ...)` method, REPLACE the simple ShowAsync call with:**

```csharp
// Show notification using platform service
if (_localNotificationService != null)
{
    // ? ADD deep link data for match notifications
    if (!string.IsNullOrEmpty(notification.EventCode) && notification.EventId.HasValue)
{
        var deepLinkData = new Dictionary<string, string>
     {
            { "type", "match" },
    { "eventCode", notification.EventCode },
            { "eventId", notification.EventId.Value.ToString() },
            { "matchNumber", notification.MatchNumber?.ToString() ?? "" }
     };
        
        System.Diagnostics.Debug.WriteLine($"[BackgroundNotifications] Adding deep link data to match notification");
        
        await _localNotificationService.ShowWithDataAsync(title, message, notification.Id, deepLinkData);
    }
    else
    {
        // Fallback to simple notification without deep link
        await _localNotificationService.ShowAsync(title, message, id: notification.Id);
    }
}
```

**Do the same for `ShowNotificationAsync(PastNotification ...)` method.**

### 3. Update MainActivity to Handle Match Notifications

**File:** `ObsidianScout/Platforms/Android/MainActivity.cs`

**In `StoreNotificationIntentForLater()` method:**

```csharp
private void StoreNotificationIntentForLater(Intent? intent)
{
    if (intent == null)
    {
        System.Diagnostics.Debug.WriteLine("[MainActivity] Intent is null, skipping");
        return;
    }

    try
    {
      var type = intent.GetStringExtra("type");
     var sourceType = intent.GetStringExtra("sourceType");
        var sourceId = intent.GetStringExtra("sourceId");
        var messageId = intent.GetStringExtra("messageId");
  var eventCode = intent.GetStringExtra("eventCode");  // ? ADD
        var eventId = intent.GetStringExtra("eventId");      // ? ADD
        var matchNumber = intent.GetStringExtra("matchNumber"); // ? ADD

        System.Diagnostics.Debug.WriteLine($"[MainActivity] Checking intent extras:");
        System.Diagnostics.Debug.WriteLine($"type: {type}");
        System.Diagnostics.Debug.WriteLine($"  sourceType: {sourceType}");
        System.Diagnostics.Debug.WriteLine($"  sourceId: {sourceId}");
 System.Diagnostics.Debug.WriteLine($"  eventCode: {eventCode}");  // ? ADD
        System.Diagnostics.Debug.WriteLine($"  eventId: {eventId}");      // ? ADD
        System.Diagnostics.Debug.WriteLine($"  matchNumber: {matchNumber}"); // ? ADD

        string? navUri = null;

        if (type == "chat" && !string.IsNullOrEmpty(sourceType) && !string.IsNullOrEmpty(sourceId))
        {
        // Build navigation URI for chat
            navUri = $"//Chat?sourceType={sourceType}&sourceId={System.Uri.EscapeDataString(sourceId)}";
            System.Diagnostics.Debug.WriteLine($"[MainActivity] ? Chat intent detected");
        }
        else if (type == "match" && !string.IsNullOrEmpty(eventId))  // ? ADD THIS BLOCK
    {
      // Build navigation URI for matches page
     navUri = $"//MatchesPage?eventId={eventId}";
        
            if (!string.IsNullOrEmpty(eventCode))
    {
                navUri += $"&eventCode={System.Uri.EscapeDataString(eventCode)}";
        }
    
        System.Diagnostics.Debug.WriteLine($"[MainActivity] ? Match intent detected");
        }

        if (!string.IsNullOrEmpty(navUri))
        {
            _pendingNavigationUri = navUri;
     _hasPendingNavigation = true;
     
       System.Diagnostics.Debug.WriteLine($"[MainActivity] ? Stored pending navigation: {navUri}");
 System.Diagnostics.Debug.WriteLine($"[MainActivity] Will navigate after app initialization completes");
        }
        else
        {
            System.Diagnostics.Debug.WriteLine($"[MainActivity] ? Invalid notification intent - not storing");
        }
    }
    catch (System.Exception ex)
    {
        System.Diagnostics.Debug.WriteLine($"[MainActivity] StoreNotificationIntent error: {ex.Message}");
    }
}
```

### 4. Enhanced Logging in App.xaml.cs (Already Done ?)

The `OnResume()` method now has comprehensive logging to diagnose navigation issues.

---

## ?? Testing Instructions

### Test Chat Notifications

1. Stop and clean rebuild app
2. Deploy app
3. Have someone send you a chat message
4. Wait 60 seconds
5. Tap notification
6. **Check logs** for these key messages:

```powershell
adb logcat | findstr "MainActivity\|App\|ChatPage"
```

**Expected logs:**
```
[MainActivity] ? Stored pending navigation: //Chat?sourceType=dm&sourceId=alice
[App] HasPendingNavigation: True
[App] Pending navigation URI: //Chat?sourceType=dm&sourceId=alice
[App] Found pending navigation in OnResume: //Chat?sourceType=dm&sourceId=alice
[App] On main thread, Shell.Current: True
[App] Executing pending navigation from OnResume: //Chat?sourceType=dm&sourceId=alice
[App] ? Pending navigation completed from OnResume
[ChatPage] Handling deep link: dm/alice
[ChatPage] ? Opened DM with alice
```

**If navigation DOESN'T happen**, look for:
- ? `[App] HasPendingNavigation: False` ? Intent not stored
- ? `[App] Shell.Current: False` ? Shell not ready (increase delay)
- ? Navigation exception ? Route not registered or parameters wrong

### Test Match Notifications

1. Create a match notification subscription on server
2. Wait for notification
3. Tap notification
4. Should navigate to MatchesPage with event pre-selected

**Expected logs:**
```
[MainActivity] ? Stored pending navigation: //MatchesPage?eventId=5&eventCode=TXPLA2
[App] Executing pending navigation from OnResume: //MatchesPage?eventId=5&eventCode=TXPLA2
[App] ? Pending navigation completed from OnResume
```

---

## ?? Troubleshooting Chat Navigation

### Issue: Logs show "Stored pending navigation" but no execution

**Problem:** `OnResume()` not being called or not checking for pending navigation

**Fix:** Verify `App.xaml.cs` `OnResume()` has the Android-specific check:

```csharp
#if ANDROID
System.Diagnostics.Debug.WriteLine("[App] Checking for pending navigation on OnResume...");
// ... check and execute code ...
#endif
```

### Issue: "Shell.Current is null"

**Problem:** App not fully initialized

**Fix:** Increase delay in `App.xaml.cs`:

```csharp
await Task.Delay(2000); // Increase from 1000ms
```

### Issue: Navigation executes but page doesn't change

**Problem:** Route not registered or wrong route name

**Fix:** Verify in `AppShell.xaml.cs`:

```csharp
Routing.RegisterRoute("Chat", typeof(ChatPage));
Routing.RegisterRoute("ChatPage", typeof(ChatPage));
Routing.RegisterRoute("MatchesPage", typeof(MatchesPage));
```

### Issue: "No pending navigation found"

**Problem:** Intent extras not being set by notification service

**Fix:** Verify `LocalNotificationService.ShowWithDataAsync()` is adding extras to PendingIntent:

```csharp
// In LocalNotificationService.cs
foreach (var kvp in data)
{
    intent.PutExtra(kvp.Key, kvp.Value);
    System.Diagnostics.Debug.WriteLine($"[LocalNotifications]   {kvp.Key} = {kvp.Value}");
}
```

---

## ?? Complete Navigation Flow

```
???????????????????????????????????????????????????????????????
?  1. BackgroundNotificationService detects notification      ?
?     ?? Chat: From unread messages    ?
?     ?? Match: From scheduled/past notifications   ?
???????????????????????????????????????????????????????????????
  ?
         ?
???????????????????????????????????????????????????????????????
?  2. Call LocalNotificationService.ShowWithDataAsync()    ?
?     ?? Chat: type=chat, sourceType=dm, sourceId=alice      ?
?     ?? Match: type=match, eventId=5, eventCode=TXPLA2      ?
???????????????????????????????????????????????????????????????
         ?
     ?
???????????????????????????????????????????????????????????????
?  3. Android creates notification with PendingIntent         ?
?     containing the deep link data as extras                 ?
???????????????????????????????????????????????????????????????
         ?
  ?
???????????????????????????????????????????????????????????????
?  4. User taps notification    ?
???????????????????????????????????????????????????????????????
   ?
  ?
???????????????????????????????????????????????????????????????
?  5. MainActivity.OnNewIntent() called ?
?     ?? StoreNotificationIntentForLater()           ?
?    ?? Extract intent extras       ?
?        ?? Build navigation URI    ?
?     ?? Store in _pendingNavigationUri  ?
???????????????????????????????????????????????????????????????
    ?
               ?
???????????????????????????????????????????????????????????????
?  6. App.OnResume() called       ?
?     ?? CheckAndExecutePendingNavigation()   ?
?        ?? Get pending URI from MainActivity  ?
?        ?? Wait 1000ms for stability               ?
?        ?? Shell.Current.GoToAsync(uri)       ?
?      ?? Clear pending navigation  ?
???????????????????????????????????????????????????????????????
          ?
    ?
???????????????????????????????????????????????????????????????
?  7. Shell navigation resolves route      ?
?     ?? "//Chat?..." ? ChatPage    ?
?     ?? "//MatchesPage?..." ? MatchesPage          ?
???????????????????????????????????????????????????????????????
          ?
   ?
???????????????????????????????????????????????????????????????
?  8. Page receives query parameters and navigates       ?
?     ?? ChatPage: Opens conversation with sourceId       ?
? ?? MatchesPage: Filters by eventId          ?
???????????????????????????????????????????????????????????????
```

---

## ? Success Criteria

### Chat Notifications
- [ ] Notification shows message text (not generic)
- [ ] Tapping notification opens app
- [ ] Navigates to ChatPage
- [ ] Opens conversation with correct user
- [ ] Messages display

### Match Notifications
- [ ] Notification shows match details
- [ ] Tapping notification opens app
- [ ] Navigates to MatchesPage
- [ ] Event is pre-selected
- [ ] Matches for that event display

---

## ?? Next Steps

1. **Clean rebuild:**
```powershell
dotnet clean
dotnet build -f net10.0-android
```

2. **Deploy and test chat notifications:**
   - Get notification
   - Tap it
 - Capture full logs

3. **Share logs** if navigation still doesn't work - we need to see:
   - `[MainActivity] Checking intent extras:`
- `[App] HasPendingNavigation:`
   - `[App] Executing pending navigation:`
   - Any errors or exceptions

4. **Test match notifications** once chat is working

---

**Status:** Implementation complete, needs testing to diagnose chat navigation issue

**Deploy:** NOW - capture detailed logs ??
