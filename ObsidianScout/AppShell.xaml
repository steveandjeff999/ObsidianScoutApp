<?xml version="1.0" encoding="UTF-8" ?>
<Shell
 x:Class="ObsidianScout.AppShell"
 xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
 xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
 xmlns:local="clr-namespace:ObsidianScout"
 xmlns:views="clr-namespace:ObsidianScout.Views"
 Title="ObsidianScout"
 FlyoutBehavior="Flyout"
 FlyoutBackgroundColor="{AppThemeBinding Light={StaticResource LightSurface}, Dark={StaticResource DarkBackground}}"
 FlyoutHeaderBehavior="Fixed">

 <Shell.Resources>
 <ResourceDictionary>
 <!-- Modern flyout item template: icon + label -->
 <DataTemplate x:Key="FlyoutItemTemplate">
 <Grid HeightRequest="54" Padding="16,8">
 <!-- Single centered text column for a clean icon-free flyout -->
 <Label
 Text="{Binding Title}"
 VerticalOptions="Center"
 HorizontalOptions="Start"
 FontSize="16"
 FontFamily="OpenSansRegular"
 TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
 </Grid>
 </DataTemplate>

 <!-- Apply the template to FlyoutItems -->
 <Style TargetType="FlyoutItem" ApplyToDerivedTypes="True">
 <Setter Property="Shell.ItemTemplate" Value="{StaticResource FlyoutItemTemplate}" />
 <!-- Ensure consistent flyout item background -->
 <Setter Property="Shell.BackgroundColor" Value="{AppThemeBinding Light={StaticResource LightSurface}, Dark={StaticResource DarkSurface}}" />
 </Style>

 <!-- Small section header used inside flyout content when needed -->
 <Style x:Key="FlyoutSectionHeader" TargetType="Label">
 <Setter Property="FontAttributes" Value="Bold" />
 <Setter Property="FontSize" Value="12" />
 <Setter Property="TextColor" Value="{AppThemeBinding Light={StaticResource TextTertiary}, Dark={StaticResource DarkTextSecondary}}" />
 <Setter Property="Margin" Value="12,8,12,4" />
 </Style>
 </ResourceDictionary>
 </Shell.Resources>

 <!-- TitleView used to display an offline banner across the top when IsOfflineMode or a connection problem exists -->
 <Shell.TitleView>
 <!-- Use a ContentView that collapses when ShowTitleBanner is false -->
 <ContentView x:Name="TitleContainer" IsVisible="{Binding ShowTitleBanner}" BackgroundColor="Transparent" Padding="0" HorizontalOptions="FillAndExpand" MinimumHeightRequest="0">
 <ContentView.Triggers>
 <DataTrigger TargetType="ContentView" Binding="{Binding ShowTitleBanner}" Value="False">
 <Setter Property="HeightRequest" Value="0" />
 <Setter Property="MinimumHeightRequest" Value="0" />
 <Setter Property="IsVisible" Value="False" />
 </DataTrigger>
 <DataTrigger TargetType="ContentView" Binding="{Binding ShowTitleBanner}" Value="True">
 <!-- Reserve enough vertical space for multi-line banners so they are not clipped by the nav bar -->
 <Setter Property="MinimumHeightRequest" Value="78" />
 <Setter Property="Padding" Value="0" />
 </DataTrigger>
 </ContentView.Triggers>

 <VerticalStackLayout Spacing="0" HorizontalOptions="FillAndExpand">
 <!-- Offline label (shows only in offline mode) -->
 <Frame IsVisible="{Binding IsOfflineMode}" BackgroundColor="#FFF59D" Padding="6" HasShadow="False" CornerRadius="0" HorizontalOptions="FillAndExpand" Margin="0">
 <Label Text="Offline â€” using cached data" TextColor="#000" HorizontalTextAlignment="Center" VerticalOptions="Center" LineBreakMode="WordWrap" />
 </Frame>

 <!-- Connection problem banner: visible when ShowConnectionBanner is true -->
 <Grid IsVisible="{Binding ShowConnectionBanner}" BackgroundColor="#FFCC80" Padding="8" ColumnDefinitions="*,Auto,Auto" ColumnSpacing="8" HorizontalOptions="FillAndExpand" VerticalOptions="Start">
 <Label Grid.Column="0"
 Text="{Binding ConnectionProblemMessage}"
 VerticalOptions="Center"
 HorizontalOptions="StartAndExpand"
 FontSize="14"
 TextColor="#000"
 HorizontalTextAlignment="Start"
 LineBreakMode="WordWrap"
 Margin="0,4" />

 <!-- Buttons: ensure they don't force extra reserved height when hidden -->
 <Button Grid.Column="1" Text="Yes" Clicked="OnEnableOfflineClicked" BackgroundColor="#4CAF50" TextColor="#FFF" MinimumWidthRequest="70" HeightRequest="36" />
 <Button Grid.Column="2" Text="No" Clicked="OnDismissConnectionClicked" BackgroundColor="#F44336" TextColor="#FFF" MinimumWidthRequest="70" HeightRequest="36" />
 </Grid>
 </VerticalStackLayout>
 </ContentView>
 </Shell.TitleView>

 <!-- Flyout Header: avatar, username, team, offline toggle -->
 <Shell.FlyoutHeader>
 <!-- Two-row grid: header content + subtle shadow line -->
 <Grid>
 <Grid.RowDefinitions>
 <RowDefinition Height="Auto" />
 <RowDefinition Height="2" />
 </Grid.RowDefinitions>

 <!-- Header content -->
 <Grid Grid.Row="0" Padding="0" Background="{AppThemeBinding Light={StaticResource FlyoutHeaderBrushLight}, Dark={StaticResource FlyoutHeaderBrushDark}}">
 <Grid.RowDefinitions>
 <RowDefinition Height="Auto" />
 <RowDefinition Height="Auto" />
 </Grid.RowDefinitions>

 <HorizontalStackLayout Spacing="12" VerticalOptions="Center" Padding="16">
 <!-- Avatar circle with proper layering -->
 <Grid WidthRequest="{StaticResource FlyoutAvatarSize}" HeightRequest="{StaticResource FlyoutAvatarSize}" HorizontalOptions="Start" VerticalOptions="Center" Margin="0,0,0,8">
 <!-- Background circle -->
 <Ellipse Fill="{AppThemeBinding Light=White, Dark={StaticResource DarkSurfaceElevated}}"
 WidthRequest="{StaticResource FlyoutAvatarSize}"
 HeightRequest="{StaticResource FlyoutAvatarSize}"
 Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#505050}"
 StrokeThickness="1" />

 <!-- Profile picture with circular clip (size driven by tokens) -->
 <Image Source="{Binding ProfilePictureSource}"
 Aspect="AspectFill"
 IsVisible="{Binding HasProfilePicture}"
 WidthRequest="{StaticResource FlyoutAvatarSize}"
 HeightRequest="{StaticResource FlyoutAvatarSize}"
 HorizontalOptions="Center"
 VerticalOptions="Center">
 <Image.Clip>
 <!-- Center uses radius value (adjust token if changing) -->
 <EllipseGeometry Center="40,40" RadiusX="{StaticResource FlyoutAvatarRadius}" RadiusY="{StaticResource FlyoutAvatarRadius}" />
 </Image.Clip>
 </Image>

 <!-- Fallback initials label -->
 <Label Text="{Binding UserInitials}"
 HorizontalTextAlignment="Center"
 VerticalTextAlignment="Center"
 FontSize="20"
 FontAttributes="Bold"
 TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}"
 IsVisible="{Binding HasProfilePicture, Converter={StaticResource InvertedBoolConverter}}"
 HorizontalOptions="Center"
 VerticalOptions="Center" />
 </Grid>

 <VerticalStackLayout VerticalOptions="Center" Spacing="2">
 <Label Text="{Binding CurrentUsername}" FontSize="18" FontAttributes="Bold" TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}">
                            <Label.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnUserTapped" NumberOfTapsRequired="1" />
                            </Label.GestureRecognizers>
                        </Label>
 <Label Text="{Binding CurrentTeamInfo}" FontSize="13" TextColor="{AppThemeBinding Light={StaticResource TextTertiary}, Dark={StaticResource DarkTextSecondary}}" Opacity="0.9" />

 <HorizontalStackLayout Spacing="8" VerticalOptions="Center" Padding="0,6,0,0">
 <Label Text="Offline Mode" FontSize="13" TextColor="{AppThemeBinding Light={StaticResource TextTertiary}, Dark={StaticResource DarkTextSecondary}}" Opacity="0.9" VerticalOptions="Center" />
 <Switch IsToggled="{Binding IsOfflineMode, Mode=TwoWay}" Toggled="OnOfflineModeToggled" HorizontalOptions="Start" VerticalOptions="Center" />
 </HorizontalStackLayout>
 </VerticalStackLayout>
 </HorizontalStackLayout>
 </Grid>

 <!-- Subtle shadow line to give elevation -->
 <BoxView Grid.Row="1" HeightRequest="2" BackgroundColor="Black" Opacity="0.12" />
 </Grid>
 </Shell.FlyoutHeader>

 <!-- Primary application pages (use vector icons from IconFonts resource dictionary) -->
 <FlyoutItem Title="Home" IsVisible="{Binding IsLoggedIn}" Route="MainPage">
 <ShellContent ContentTemplate="{DataTemplate local:MainPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Scouting" IsVisible="{Binding IsLoggedIn}" Route="ScoutingLandingPage">
 <ShellContent ContentTemplate="{DataTemplate views:ScoutingLandingPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Pit Scouting" IsVisible="{Binding IsLoggedIn}" Route="PitScoutingPage">
 <ShellContent ContentTemplate="{DataTemplate views:PitScoutingPage}" />
 </FlyoutItem>

 <FlyoutItem Title="QR Scanner" IsVisible="{Binding IsLoggedIn}" Route="QRCodeScannerPage">
 <ShellContent ContentTemplate="{DataTemplate views:QRCodeScannerPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Teams" IsVisible="{Binding IsLoggedIn}" Route="TeamsPage">
 <ShellContent ContentTemplate="{DataTemplate views:TeamsPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Events" IsVisible="{Binding IsLoggedIn}" Route="EventsPage">
 <ShellContent ContentTemplate="{DataTemplate views:EventsPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Matches" IsVisible="{Binding IsLoggedIn}" Route="MatchesPage">
 <ShellContent ContentTemplate="{DataTemplate views:MatchesPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Graphs" IsVisible="{Binding IsLoggedIn}" Route="GraphsPage">
 <ShellContent ContentTemplate="{DataTemplate views:GraphsPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Match Prediction" IsVisible="{Binding IsLoggedIn}" Route="MatchPredictionPage">
 <ShellContent ContentTemplate="{DataTemplate views:MatchPredictionPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Server Data" IsVisible="{Binding IsLoggedIn}" Route="DataPage">
 <ShellContent ContentTemplate="{DataTemplate views:DataPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Management" IsVisible="{Binding HasManagementAccess}" Route="ManagementPage">
 <ShellContent ContentTemplate="{DataTemplate views:ManagementPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Manage Users" IsVisible="{Binding HasManagementAccess}" Route="ManageUsersPage">
 <ShellContent ContentTemplate="{DataTemplate views:ManageUsersPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Chat" IsVisible="{Binding IsLoggedIn}" Route="ChatPage">
 <ShellContent ContentTemplate="{DataTemplate views:ChatPage}" />
 </FlyoutItem>

 <!-- Settings and Login -->
 <FlyoutItem Title="Settings" IsVisible="{Binding IsLoggedIn}">
 <ShellContent Route="SettingsPage" ContentTemplate="{DataTemplate views:SettingsPage}" />
 </FlyoutItem>

 <FlyoutItem Title="Login" IsVisible="{Binding IsLoggedOut}" Route="LoginPage">
 <ShellContent ContentTemplate="{DataTemplate views:LoginPage}" />
 </FlyoutItem>

 <!-- Flyout Footer: Settings + Logout compact row -->
 <Shell.FlyoutFooter>
 <Grid Padding="12" BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant}, Dark={StaticResource DarkSurface}}">
 <Grid.ColumnDefinitions>
 <ColumnDefinition Width="*" />
 <ColumnDefinition Width="Auto" />
 </Grid.ColumnDefinitions>

 <VerticalStackLayout Grid.Column="0" Spacing="2" VerticalOptions="Center">
 <Label Text="{Binding CurrentUsername}" FontSize="14" FontAttributes="Bold" TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
 <Label Text="{Binding CurrentTeamInfo}" FontSize="12" TextColor="{AppThemeBinding Light={StaticResource TextTertiary}, Dark={StaticResource DarkTextSecondary}}" />
 </VerticalStackLayout>

 <HorizontalStackLayout Grid.Column="1" Spacing="8" VerticalOptions="Center">
 <Button Text="Settings" Clicked="OnFooterSettingsClicked" Style="{StaticResource OutlineGlassButton}" />
 <Button Text="Logout" Clicked="OnLogoutClicked" Style="{StaticResource OutlineGlassButton}" />
 </HorizontalStackLayout>
 </Grid>
 </Shell.FlyoutFooter>

</Shell>
