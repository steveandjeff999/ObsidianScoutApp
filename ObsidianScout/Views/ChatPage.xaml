<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
      xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
     xmlns:viewmodels="clr-namespace:ObsidianScout.ViewModels"
    xmlns:models="clr-namespace:ObsidianScout.Models"
        xmlns:converters="clr-namespace:ObsidianScout.Converters"
             x:Class="ObsidianScout.Views.ChatPage"
 x:DataType="viewmodels:ChatViewModel"
   x:Name="RootPage"
             Title="Chat">

    <ContentPage.Resources>
        <ResourceDictionary>
   <converters:InvertedBoolConverter x:Key="InvertedBool" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <Grid RowDefinitions="Auto,Auto,*,Auto" Padding="20" RowSpacing="12">

   <!-- HEADER -->
        <Border Grid.Row="0" Style="{StaticResource CompactGlassCard}">
       <HorizontalStackLayout Spacing="12">
  <Border BackgroundColor="{StaticResource Primary}"
WidthRequest="40"
     HeightRequest="40"
       VerticalOptions="Center">
   <Border.StrokeShape>
     <RoundRectangle CornerRadius="10" />
   </Border.StrokeShape>
        <Label Text="C"
   FontSize="20"
      FontFamily="OpenSansSemibold"
         FontAttributes="Bold"
 TextColor="White"
   HorizontalOptions="Center"
      VerticalOptions="Center" />
 </Border>
     <Label Text="Chat" 
   Style="{StaticResource HeaderLabel}" 
FontSize="24"
     VerticalOptions="Center" />
    </HorizontalStackLayout>
        </Border>

  <!-- CONTROLS -->
        <Border Grid.Row="1" Style="{StaticResource ModernCard}">
<Grid RowDefinitions="Auto,Auto,Auto" RowSpacing="12">
                
 <!-- Row 0: Group Chat Toggle -->
          <HorizontalStackLayout Grid.Row="0" Spacing="12" VerticalOptions="Center">
        <Label Text="Group Chat" 
        Style="{StaticResource BodyLabel}" 
      VerticalOptions="Center" />
   <Switch IsToggled="{Binding IsAllianceChat}" 
      VerticalOptions="Center" />
        </HorizontalStackLayout>

         <!-- Row 1: Recipient/Group Picker -->
    <Grid Grid.Row="1" ColumnDefinitions="*,Auto" ColumnSpacing="12">
        <!-- Direct recipient picker -->
  <Border Grid.Column="0"
    BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant}, Dark={StaticResource DarkSurfaceVariant}}"
    StrokeThickness="0"
        Padding="0"
              IsVisible="{Binding IsAllianceChat, Converter={StaticResource InvertedBool}}">
            <Border.StrokeShape>
    <RoundRectangle CornerRadius="12" />
      </Border.StrokeShape>
    <Picker Title="Select recipient"
           ItemsSource="{Binding Members}"
      ItemDisplayBinding="{Binding DisplayName}"
            SelectedItem="{Binding SelectedMember}"
        Style="{StaticResource ModernPicker}"
    BackgroundColor="Transparent"
               IsEnabled="{Binding IsAllianceChat, Converter={StaticResource InvertedBool}}" />
        </Border>

 <!-- Group picker -->
    <Border Grid.Column="0"
      BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant}, Dark={StaticResource DarkSurfaceVariant}}"
                StrokeThickness="0"
   Padding="0"
                 IsVisible="{Binding IsAllianceChat}">
        <Border.StrokeShape>
        <RoundRectangle CornerRadius="12" />
     </Border.StrokeShape>
             <Picker Title="Select group"
    ItemsSource="{Binding Groups}"
            ItemDisplayBinding="{Binding Title}"
    SelectedItem="{Binding SelectedGroup}"
      Style="{StaticResource ModernPicker}"
      BackgroundColor="Transparent" />
       </Border>

         <!-- New Group Button -->
     <Button Grid.Column="1"
     Text="+"
       Style="{StaticResource IconButton}"
       Clicked="OnCreateGroupClicked"
             IsVisible="{Binding IsAllianceChat}"
      ToolTipProperties.Text="New Group" />
      </Grid>

  <!-- Row 2: Group Actions -->
   <HorizontalStackLayout Grid.Row="2" 
     Spacing="12" 
   IsVisible="{Binding IsAllianceChat}">
           <Button Text="Join Group"
        Command="{Binding JoinGroupCommand}"
         Style="{StaticResource OutlineButton}"
                FontSize="14"
       Padding="16,10"
     HeightRequest="44"
        HorizontalOptions="FillAndExpand" />
           <Button Text="Leave Group"
    Command="{Binding LeaveGroupCommand}"
            Style="{StaticResource OutlineButton}"
         FontSize="14"
       Padding="16,10"
    HeightRequest="44"
   HorizontalOptions="FillAndExpand" />
            </HorizontalStackLayout>
            </Grid>
        </Border>

        <!-- MESSAGES LIST -->
        <CollectionView x:Name="MessagesList" 
         Grid.Row="2" 
              ItemsSource="{Binding Messages}" 
              SelectionMode="None">
         <CollectionView.ItemTemplate>
 <DataTemplate x:DataType="models:ChatMessage">
             <SwipeView Margin="0,0,0,12">
            <SwipeView.RightItems>
              <SwipeItems Mode="Reveal">
      <SwipeItem Text="React" 
          BackgroundColor="{AppThemeBinding Light={StaticResource LightWarning}, Dark={StaticResource DarkWarning}}" 
         Invoked="OnMessageReactInvoked" />
           <SwipeItem Text="Edit" 
    BackgroundColor="{AppThemeBinding Light={StaticResource LightInfo}, Dark={StaticResource DarkInfo}}" 
           Command="{Binding BindingContext.EditMessageCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}" 
     CommandParameter="{Binding .}" 
        IsVisible="{Binding IsFromCurrentUser}"/>
        <SwipeItem Text="Delete" 
  BackgroundColor="{AppThemeBinding Light={StaticResource LightError}, Dark={StaticResource DarkError}}" 
      Command="{Binding BindingContext.DeleteMessageCommand, Source={RelativeSource AncestorType={x:Type ContentPage}}}" 
  CommandParameter="{Binding .}" 
      IsVisible="{Binding IsFromCurrentUser}"/>
         </SwipeItems>
                 </SwipeView.RightItems>

        <Border Style="{StaticResource ModernCard}" Padding="16">
       <Border.GestureRecognizers>
     <TapGestureRecognizer Tapped="OnMessageTapped" NumberOfTapsRequired="1" />
   </Border.GestureRecognizers>

         <Grid RowDefinitions="Auto,Auto,Auto,Auto" RowSpacing="6">
  <!-- Sender -->
           <Label Grid.Row="0"
    Text="{Binding Sender}" 
         Style="{StaticResource AccentLabel}"
     FontSize="14" />

   <!-- Message Text with WordWrap -->
   <Label Grid.Row="1"
       Text="{Binding Text}" 
          Style="{StaticResource BodyLabel}"
              FontSize="16"
    LineBreakMode="WordWrap"
                MaxLines="-1" />

      <!-- Reactions -->
     <Label Grid.Row="2"
       Text="{Binding ReactionPreview}" 
      FontSize="16"
                HorizontalOptions="Start"
          IsVisible="{Binding ReactionPreview, Converter={StaticResource StringNotEmptyConverter}}"
     LineBreakMode="WordWrap" />

            <!-- Timestamp -->
     <Label Grid.Row="3"
         Text="{Binding Timestamp, StringFormat='{0:g}'}" 
      Style="{StaticResource CaptionLabel}"
   FontSize="12"
   HorizontalOptions="End" />
</Grid>
</Border>
               </SwipeView>
     </DataTemplate>
            </CollectionView.ItemTemplate>
   </CollectionView>

        <!-- MESSAGE INPUT -->
        <Border Grid.Row="3" 
       Style="{StaticResource ModernCard}" 
         Padding="12">
        <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
     <!-- Message Entry -->
    <Border Grid.Column="0"
       BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant}, Dark={StaticResource DarkSurfaceVariant}}"
      StrokeThickness="0"
            Padding="0">
           <Border.StrokeShape>
         <RoundRectangle CornerRadius="12" />
        </Border.StrokeShape>
      <Entry Placeholder="Type a message..." 
       Text="{Binding MessageText}"
        Style="{StaticResource ModernEntry}"
 BackgroundColor="Transparent"
          Completed="OnEntryCompleted"
      MaxLength="500" />
     </Border>

        <!-- Send Button -->
       <Button Grid.Column="1"
     Text="📤"
            Command="{Binding SendMessageCommand}"
      IsEnabled="{Binding IsSendEnabled}"
Style="{StaticResource IconButton}"
             BackgroundColor="{AppThemeBinding Light={StaticResource LightPrimary}, Dark={StaticResource DarkPrimary}}"
  TextColor="White"
             ToolTipProperties.Text="Send Message" />
      </Grid>
        </Border>

    </Grid>
</ContentPage>