<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
       xmlns:viewmodels="clr-namespace:ObsidianScout.ViewModels"
             xmlns:models="clr-namespace:ObsidianScout.Models"
          x:Class="ObsidianScout.Views.MatchesPage"
           x:DataType="viewmodels:MatchesViewModel"
     Title="Matches">

    <Grid RowDefinitions="Auto,*">
        
        <!-- Header Card -->
      <Border Grid.Row="0"
         Style="{StaticResource CompactGlassCard}"
    Margin="20,20,20,10">
   <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
          <VerticalStackLayout Grid.Column="0" Spacing="4">
  <Label Text="Match Schedule"
       Style="{StaticResource HeaderLabel}"
     FontSize="24"
   LineBreakMode="NoWrap" />
       <Label Text="Predicted times and alliance assignments"
        Style="{StaticResource CaptionLabel}"
            FontSize="12"
          Opacity="0.8"
          LineBreakMode="NoWrap" />
         </VerticalStackLayout>
         
   <Button Grid.Column="1"
        Text="↻"
             Style="{StaticResource IconButton}"
     Command="{Binding RefreshCommand}"
          IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}" />
          </Grid>
        </Border>

      <!-- Content -->
        <RefreshView Grid.Row="1"
       IsRefreshing="{Binding IsRefreshing}"
              Command="{Binding RefreshCommand}">
    
            <CollectionView ItemsSource="{Binding Matches}"
                   SelectionMode="None"
 Margin="20,0,20,20"
  RemainingItemsThreshold="5"
   RemainingItemsThresholdReachedCommand="{Binding LoadMoreCommand}">

    <!-- Performance optimization settings -->
    <CollectionView.ItemsLayout>
        <LinearItemsLayout Orientation="Vertical" 
     ItemSpacing="12"
    SnapPointsType="None" />
    </CollectionView.ItemsLayout>

      <CollectionView.EmptyView>
       <VerticalStackLayout Spacing="20"
       Padding="40"
            VerticalOptions="Center">
         
           <!-- Loading State -->
     <VerticalStackLayout Spacing="16"
         HorizontalOptions="Center"
            IsVisible="{Binding IsLoading}">
         <ActivityIndicator IsRunning="True"
     HeightRequest="50"
 WidthRequest="50" />
        <Label Text="Loading match schedule..."
   Style="{StaticResource BodyLabel}"
HorizontalTextAlignment="Center" />
           </VerticalStackLayout>

      <!-- Empty State -->
         <VerticalStackLayout Spacing="16"
      HorizontalOptions="Center"
   IsVisible="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}">
      <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant}, Dark={StaticResource DarkSurfaceVariant}}"
         WidthRequest="80"
 HeightRequest="80"
     HorizontalOptions="Center">
       <Border.StrokeShape>
     <RoundRectangle CornerRadius="20" />
     </Border.StrokeShape>
       <Label Text="M"
     FontSize="40"
 FontFamily="OpenSansSemibold"
           TextColor="{AppThemeBinding Light={StaticResource LightTextTertiary}, Dark={StaticResource DarkTextTertiary}}"
   HorizontalOptions="Center"
     VerticalOptions="Center" />
          </Border>
        <Label Text="No Matches Scheduled"
          Style="{StaticResource SubheaderLabel}"
        HorizontalTextAlignment="Center" />
        <Label Text="Pull down to refresh or check your connection"
          Style="{StaticResource CaptionLabel}"
         HorizontalTextAlignment="Center" />
                  
        <!-- Error Message -->
       <Border IsVisible="{Binding ErrorMessage, Converter={StaticResource StringNotEmptyConverter}}"
Style="{StaticResource ErrorBadge}"
        HorizontalOptions="Center"
  Margin="0,10,0,0">
               <Label Text="{Binding ErrorMessage}"
     TextColor="White"
       FontSize="14"
         Padding="8,4"
            LineBreakMode="WordWrap"
     MaxLines="3" />
 </Border>
    </VerticalStackLayout>
        </VerticalStackLayout>
</CollectionView.EmptyView>

           <CollectionView.ItemTemplate>
             <DataTemplate x:DataType="models:Match">
      <Border Style="{StaticResource GlassListItem}"
    BackgroundColor="{AppThemeBinding Light={StaticResource LightSurface}, Dark={StaticResource DarkSurface}}">
 <Border.GestureRecognizers>
     <TapGestureRecognizer 
            Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:MatchesViewModel}}, Path=MatchSelectedCommand}"
        CommandParameter="{Binding .}" />
  </Border.GestureRecognizers>

              <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="16">
          
     <!-- Time Column -->
  <VerticalStackLayout Grid.Column="0"
         Spacing="4"
    VerticalOptions="Center"
         WidthRequest="80">
           <!-- Match Status Indicator -->
 <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightPrimary}, Dark={StaticResource DarkPrimary}}"
    WidthRequest="8"
                HeightRequest="8"
           HorizontalOptions="Center"
           IsVisible="{Binding IsInProgress}">
          <Border.StrokeShape>
             <RoundRectangle CornerRadius="4" />
           </Border.StrokeShape>
             </Border>
        
              <!-- Time Display -->
        <Label Text="{Binding TimeDisplay}"
    Style="{StaticResource SubheaderLabel}"
               FontSize="18"
       HorizontalTextAlignment="Center"
              LineBreakMode="NoWrap" />
           <Label Text="{Binding DateDisplay}"
       Style="{StaticResource CaptionLabel}"
    FontSize="11"
     HorizontalTextAlignment="Center"
      LineBreakMode="NoWrap"
      Opacity="0.8"
   IsVisible="{Binding HasTime}" />
   </VerticalStackLayout>

 <!-- Match Info Column -->
            <VerticalStackLayout Grid.Column="1"
           Spacing="12"
   VerticalOptions="Center">
      
  <!-- Match Title & Type -->
 <HorizontalStackLayout Spacing="8">
           <Label Style="{StaticResource SubheaderLabel}"
    FontSize="16"
                 LineBreakMode="NoWrap">
       <Label.FormattedText>
           <FormattedString>
              <Span Text="{Binding MatchType}" />
     <Span Text=" " />
                <Span Text="{Binding MatchNumber}" />
 </FormattedString>
           </Label.FormattedText>
               </Label>
           
      <!-- Status Badge -->
       <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightSuccess}, Dark={StaticResource DarkSuccess}}"
             Padding="8,4"
     IsVisible="{Binding IsCompleted}">
 <Border.StrokeShape>
         <RoundRectangle CornerRadius="8" />
         </Border.StrokeShape>
        <Label Text="Complete"
            TextColor="White"
    FontSize="10"
    FontFamily="OpenSansSemibold"
        LineBreakMode="NoWrap" />
  </Border>

     <Border BackgroundColor="{AppThemeBinding Light={StaticResource LightInfo}, Dark={StaticResource DarkInfo}}"
               Padding="8,4"
         IsVisible="{Binding IsInProgress}">
           <Border.StrokeShape>
   <RoundRectangle CornerRadius="8" />
  </Border.StrokeShape>
   <Label Text="Live"
           TextColor="White"
          FontSize="10"
              FontFamily="OpenSansSemibold"
        LineBreakMode="NoWrap" />
       </Border>
    </HorizontalStackLayout>

     <!-- Red Alliance -->
              <HorizontalStackLayout Spacing="10">
                    <Border BackgroundColor="{AppThemeBinding Light={StaticResource AllianceRed}, Dark={StaticResource AllianceRed}}"
      WidthRequest="6"
      HeightRequest="32"
     VerticalOptions="Center">
          <Border.StrokeShape>
   <RoundRectangle CornerRadius="3" />
             </Border.StrokeShape>
  </Border>
         <VerticalStackLayout Spacing="2">
        <Label Text="RED ALLIANCE"
             FontSize="10"
       FontFamily="OpenSansSemibold"
     TextColor="{AppThemeBinding Light={StaticResource AllianceRedDark}, Dark={StaticResource AllianceRed}}"
   LineBreakMode="NoWrap" />
       <Label Text="{Binding RedTeams}"
           Style="{StaticResource BodyLabel}"
      FontSize="13"
       LineBreakMode="WordWrap"
       MaxLines="2" />
    <!-- Score Display -->
             <Label Text="{Binding RedScore, StringFormat='Score: {0}'}"
    Style="{StaticResource CaptionLabel}"
    FontSize="11"
       FontFamily="OpenSansSemibold"
          IsVisible="{Binding RedScore, Converter={StaticResource IsNotNullConverter}}"
  LineBreakMode="NoWrap" />
           </VerticalStackLayout>
           </HorizontalStackLayout>

  <!-- Blue Alliance -->
         <HorizontalStackLayout Spacing="10">
       <Border BackgroundColor="{AppThemeBinding Light={StaticResource AllianceBlue}, Dark={StaticResource AllianceBlue}}"
    WidthRequest="6"
     HeightRequest="32"
         VerticalOptions="Center">
       <Border.StrokeShape>
  <RoundRectangle CornerRadius="3" />
         </Border.StrokeShape>
            </Border>
       <VerticalStackLayout Spacing="2">
    <Label Text="BLUE ALLIANCE"
              FontSize="10"
     FontFamily="OpenSansSemibold"
  TextColor="{AppThemeBinding Light={StaticResource AllianceBlueDark}, Dark={StaticResource AllianceBlue}}"
      LineBreakMode="NoWrap" />
    <Label Text="{Binding BlueTeams}"
  Style="{StaticResource BodyLabel}"
       FontSize="13"
                 LineBreakMode="WordWrap"
         MaxLines="2" />
<!-- Score Display -->
      <Label Text="{Binding BlueScore, StringFormat='Score: {0}'}"
   Style="{StaticResource CaptionLabel}"
       FontSize="11"
    FontFamily="OpenSansSemibold"
             IsVisible="{Binding BlueScore, Converter={StaticResource IsNotNullConverter}}"
      LineBreakMode="NoWrap" />
      </VerticalStackLayout>
    </HorizontalStackLayout>
    </VerticalStackLayout>

                    <!-- Chevron -->
          <Label Grid.Column="2"
           Text="›"
          FontSize="24"
         TextColor="{StaticResource TextTertiary}"
           VerticalOptions="Center" />
         </Grid>
         </Border>
   </DataTemplate>
      </CollectionView.ItemTemplate>
     </CollectionView>
      </RefreshView>

 <!-- Back Button (Floating) -->
        <Button Grid.Row="1"
     Text="←"
          Style="{StaticResource FAB}"
           Command="{Binding GoBackCommand}"
      VerticalOptions="End"
           HorizontalOptions="Start"
  Margin="20,0,0,20" />
    </Grid>

</ContentPage>
