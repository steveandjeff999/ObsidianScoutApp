<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:ObsidianScout.ViewModels"
             xmlns:models="clr-namespace:ObsidianScout.Models"
             x:Class="ObsidianScout.Views.HistoryPage"
             x:DataType="viewmodels:HistoryViewModel"
             Title="History">

  <Grid Padding="12">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto" />
      <RowDefinition Height="*" />
      <RowDefinition Height="Auto" />
    </Grid.RowDefinitions>

    <!-- Debug: show counts to verify binding (non-interactive) -->
    <Label Grid.Row="0" Grid.ColumnSpan="2" Text="{Binding AllScouting.Count, StringFormat='Entries: {0}'}" HorizontalOptions="Center" VerticalOptions="Center" Margin="0,4,0,0"
           TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />

    <Grid ColumnDefinitions="*,*" Grid.Row="0" Margin="0,36,0,8">
      <Button Text="Match History"
              Command="{Binding SwitchToMatchCommand}"
              BackgroundColor="Transparent"
              FontAttributes="Bold"
              HeightRequest="40"
              TextColor="{AppThemeBinding Light={StaticResource LightPrimary}, Dark={StaticResource DarkPrimary}}"
              HorizontalOptions="Center" VerticalOptions="Center" />
      <Button Text="Pit History"
              Command="{Binding SwitchToPitCommand}"
              Grid.Column="1"
              BackgroundColor="Transparent"
              FontAttributes="Bold"
              HeightRequest="40"
              TextColor="{AppThemeBinding Light={StaticResource LightPrimary}, Dark={StaticResource DarkPrimary}}"
              HorizontalOptions="Center" VerticalOptions="Center" />
    </Grid>

    <!-- Match tab -->
    <CollectionView Grid.Row="1" IsVisible="{Binding IsMatchTabSelected}" ItemsSource="{Binding AllScouting}" SelectionMode="None" ItemsLayout="VerticalList" VerticalOptions="FillAndExpand">
        <CollectionView.ItemTemplate>
          <DataTemplate x:DataType="models:ScoutingEntry">
            <Frame Padding="8" Margin="4" BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#222222}">
              <StackLayout Orientation="Vertical" VerticalOptions="Start" Spacing="6">
                <Label Text="{Binding TeamNumber, StringFormat='Team {0}'}" FontAttributes="Bold" FontSize="18"
                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />
                <Label Text="{Binding MatchNumber, StringFormat='Match {0}'}" FontSize="16"
                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />
                <Label Text="{Binding ScoutName, StringFormat='Scout: {0}'}" FontSize="14"
                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>
                  <StackLayout Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalOptions="Center">
                    <Label Text="{Binding Summary}" FontSize="14" LineBreakMode="TailTruncation"
                         TextColor="{AppThemeBinding Light=#444444, Dark=#CCCCCC}" VerticalOptions="Center" />
                    <Label Text="{Binding UploadStatus}" FontSize="12" VerticalOptions="Center" TextColor="{AppThemeBinding Light=#007700, Dark=#55FF55}" />
                  </StackLayout>
                  <Button Grid.Column="1" Text="Upload" Clicked="OnUploadEntryClicked" CommandParameter="{Binding .}" FontSize="12" IsVisible="{Binding CanUpload}" />
                  <Button Grid.Column="2" Text="View" Clicked="OnViewEntryClicked" CommandParameter="{Binding .}" FontSize="12" />
                  <Button Grid.Column="3" Text="Delete" Clicked="OnDeleteEntryClicked" CommandParameter="{Binding .}" FontSize="12" IsVisible="{Binding CanEdit}" />
                </Grid>
                <Label Text="{Binding Timestamp, StringFormat='Submitted: {0:yyyy-MM-dd HH:mm}'}" FontSize="12"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />
              </StackLayout>
            </Frame>
          </DataTemplate>
        </CollectionView.ItemTemplate>
        <CollectionView.EmptyView>
          <Label Text="No match entries" HorizontalOptions="Center" VerticalOptions="Center" />
        </CollectionView.EmptyView>
      </CollectionView>

    <!-- Pit tab -->
    <CollectionView Grid.Row="1" IsVisible="{Binding IsPitTabSelected}" ItemsSource="{Binding AllPit}" SelectionMode="None" ItemsLayout="VerticalList" VerticalOptions="FillAndExpand">
        <CollectionView.ItemTemplate>
          <DataTemplate x:DataType="models:PitScoutingEntry">
            <Frame Padding="8" Margin="4" BackgroundColor="{AppThemeBinding Light=#F0F0F0, Dark=#222222}">
              <StackLayout Orientation="Vertical" VerticalOptions="Start" Spacing="6">
                <Label Text="{Binding TeamNumber, StringFormat='Team {0}'}" FontAttributes="Bold" FontSize="18"
                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />
                <Label Text="{Binding Images.Count, StringFormat='Images: {0}'}" FontSize="14"
                       TextColor="{AppThemeBinding Light=#000000, Dark=#FFFFFF}" />
                <Grid>
                  <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                    <ColumnDefinition Width="Auto" />
                  </Grid.ColumnDefinitions>
                  <Label Grid.Column="0" Text="{Binding Data.Count, StringFormat='Fields: {0}'}" FontSize="14"
                         TextColor="{AppThemeBinding Light=#444444, Dark=#CCCCCC}" />
                  <Label Grid.Column="0" Text="{Binding UploadStatus}" FontSize="12" VerticalOptions="Center" TextColor="{AppThemeBinding Light=#007700, Dark=#55FF55}" />
                  <Button Grid.Column="1" Text="Upload" Clicked="OnUploadPitEntryClicked" CommandParameter="{Binding .}" FontSize="12" IsVisible="{Binding CanUpload}" />
                  <Button Grid.Column="2" Text="View" Clicked="OnViewPitEntryClicked" CommandParameter="{Binding .}" FontSize="12" />
                  <Button Grid.Column="3" Text="Delete" Clicked="OnDeletePitEntryClicked" CommandParameter="{Binding .}" FontSize="12" IsVisible="{Binding CanEdit}" />
                </Grid>
                <Label Text="{Binding Timestamp, StringFormat='Saved: {0:yyyy-MM-dd HH:mm}'}" FontSize="12"
                       TextColor="{AppThemeBinding Light=#666666, Dark=#AAAAAA}" />
              </StackLayout>
            </Frame>
          </DataTemplate>
        </CollectionView.ItemTemplate>
        <CollectionView.EmptyView>
          <Label Text="No pit entries" HorizontalOptions="Center" VerticalOptions="Center" />
        </CollectionView.EmptyView>
      </CollectionView>

    <StackLayout Grid.Row="2" Orientation="Horizontal" HorizontalOptions="FillAndExpand" Spacing="12">
      <Button Text="Upload All" Command="{Binding UploadAllCommand}" HorizontalOptions="Start" />
      <Label Text="{Binding StatusMessage}" HorizontalOptions="EndAndExpand" VerticalOptions="Center" />
    </StackLayout>
  </Grid>

</ContentPage>