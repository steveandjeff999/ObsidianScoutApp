<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:vm="clr-namespace:ObsidianScout.ViewModels"
             xmlns:models="clr-namespace:ObsidianScout.Models"
             xmlns:microcharts="clr-namespace:Microcharts.Maui;assembly=Microcharts.Maui"
             x:Class="ObsidianScout.Views.GraphsPage"
             x:DataType="vm:GraphsViewModel"
             Title="Team Analytics"
             BackgroundColor="{AppThemeBinding Light={StaticResource LightBackground}, Dark={StaticResource DarkBackground}}">

    <ScrollView>
        <VerticalStackLayout Padding="20" Spacing="20">

            <!-- Header -->
            <Border Style="{StaticResource ElevatedGlassCard}" BackgroundColor="{AppThemeBinding Light={StaticResource GlassOverlayLight}, Dark={StaticResource GlassOverlayDark}}">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Team Analytics &amp; Graphs"
                           FontSize="24"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                    <Label Text="Compare team performance metrics and visualize data (Powered by Microcharts - Free!)"
                           FontSize="14"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}" />
                </VerticalStackLayout>
            </Border>

            <!-- Status Message -->
            <Label Text="{Binding StatusMessage}"
                   FontSize="14"
                   TextColor="{StaticResource Tertiary}"
                   IsVisible="{Binding StatusMessage, Converter={StaticResource StringNotEmptyConverter}}"
                   HorizontalTextAlignment="Center" />

            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsLoading}"
                              IsVisible="{Binding IsLoading}"
                              Color="{StaticResource Primary}"
                              HeightRequest="40" />

            <!-- Event Selection -->
            <Border Style="{StaticResource CardBorderStyle}" BackgroundColor="{AppThemeBinding Light={StaticResource GlassOverlayLight}, Dark={StaticResource GlassOverlayDark}}">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Select Event"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                    
                    <Picker Title="Choose an event"
                            ItemsSource="{Binding Events}"
                            SelectedItem="{Binding SelectedEvent}"
                            Style="{StaticResource ModernPicker}"
                            TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}">
                        <Picker.ItemDisplayBinding>
                            <Binding Path="DisplayName" />
                        </Picker.ItemDisplayBinding>
                    </Picker>
                </VerticalStackLayout>
            </Border>

            <!-- Metric Selection -->
            <Border Style="{StaticResource CardBorderStyle}" BackgroundColor="{AppThemeBinding Light={StaticResource GlassOverlayLight}, Dark={StaticResource GlassOverlayDark}}">
                <VerticalStackLayout Spacing="10">
                    <Label Text="Select Metric"
                           FontSize="16"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                    
                    <Picker Title="Choose a metric"
                            ItemsSource="{Binding AvailableMetrics}"
                            SelectedItem="{Binding SelectedMetric}"
                            Style="{StaticResource ModernPicker}"
                            TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}">
                        <Picker.ItemDisplayBinding>
                            <Binding Path="Name" />
                        </Picker.ItemDisplayBinding>
                    </Picker>
                    
                    <Label Text="{Binding SelectedMetric.Description}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                           IsVisible="{Binding SelectedMetric, Converter={StaticResource IsNotNullConverter}}" />
                </VerticalStackLayout>
            </Border>

            <!-- Team Selection -->
            <Border Style="{StaticResource CardBorderStyle}" BackgroundColor="{AppThemeBinding Light={StaticResource GlassOverlayLight}, Dark={StaticResource GlassOverlayDark}}">
                <VerticalStackLayout Spacing="15">
                    <Grid ColumnDefinitions="*,Auto,10,Auto">
                        <Label Grid.Column="0"
                               Text="Select Teams to Compare"
                               FontSize="16"
                               FontAttributes="Bold"
                               VerticalOptions="Center"
                               TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                        
                        <Button Grid.Column="1"
                                Text="Select All"
                                Command="{Binding SelectAllTeamsCommand}"
                                Style="{StaticResource OutlineGlassButton}"
                                FontSize="12"
                                Padding="10,5"
                                IsVisible="{Binding AvailableTeams.Count, Converter={StaticResource IsNotZeroConverter}}" />
                        
                        <Button Grid.Column="3"
                                Text="Clear All"
                                Command="{Binding ClearSelectedTeamsCommand}"
                                Style="{StaticResource OutlineGlassButton}"
                                FontSize="12"
                                Padding="10,5" />
                    </Grid>

                    <!-- Selected Teams -->
                    <CollectionView ItemsSource="{Binding SelectedTeams}"
                                   IsVisible="{Binding SelectedTeams.Count, Converter={StaticResource IsNotZeroConverter}}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Team">
                                <Border Style="{StaticResource CardBorderStyle}"
                                        Margin="0,5"
                                        Padding="10">
                                    <Grid ColumnDefinitions="*,Auto">
                                        <Label Grid.Column="0"
                                               Text="{Binding TeamNumber, StringFormat='#{0} - {1}', Converter={StaticResource TeamDisplayConverter}}"
                                               VerticalOptions="Center"
                                               TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                                        
                                        <Button Grid.Column="1"
                                                Text="✕"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type vm:GraphsViewModel}}, Path=RemoveTeamFromComparisonCommand}"
                                                CommandParameter="{Binding .}"
                                                BackgroundColor="{StaticResource Tertiary}"
                                                TextColor="White"
                                                WidthRequest="30"
                                                HeightRequest="30"
                                                CornerRadius="15"
                                                Padding="0"
                                                FontSize="16" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Label Text="Select teams to compare from the list below"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                           HorizontalTextAlignment="Center" />

                    <!-- Available Teams List -->
                    <CollectionView ItemsSource="{Binding AvailableTeams}"
                                   HeightRequest="300"
                                   SelectionMode="None">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:Team">
                                <Border Style="{StaticResource CardBorderStyle}"
                                        Margin="0,5">
                                    <Border.GestureRecognizers>
                                        <TapGestureRecognizer 
                                            Command="{Binding Source={RelativeSource AncestorType={x:Type vm:GraphsViewModel}}, Path=AddTeamToComparisonCommand}"
                                            CommandParameter="{Binding .}" />
                                    </Border.GestureRecognizers>
                                    
                                    <Grid Padding="15" ColumnDefinitions="Auto,*,Auto">
                                        <Label Grid.Column="0"
                                               Text="{Binding TeamNumber, StringFormat='#{0}'}"
                                               FontAttributes="Bold"
                                               FontSize="16"
                                               TextColor="{StaticResource Primary}"
                                               VerticalOptions="Center" />
                                        
                                        <VerticalStackLayout Grid.Column="1" 
                                                           Margin="15,0,0,0"
                                                           VerticalOptions="Center">
                                            <Label Text="{Binding TeamName}"
                                                   FontSize="14"
                                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                                            <Label Text="{Binding Location}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}" />
                                        </VerticalStackLayout>
                                        
                                        <Label Grid.Column="2"
                                               Text="+"
                                               FontSize="24"
                                               TextColor="{StaticResource Primary}"
                                               VerticalOptions="Center" />
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>
                </VerticalStackLayout>
            </Border>

            <!-- Data View Selector - BEFORE Generate Button -->
            <Border Style="{StaticResource CompactGlassCard}"
                    Margin="0,0,0,10"
                    Padding="10"
                    BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant}, Dark={StaticResource DarkSurfaceVariant}}">
                <VerticalStackLayout Spacing="10">
                    <Label Text="View Mode"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                    
                    <!-- Dropdown picker for selecting data view -->
                    <Picker x:Name="DataViewPicker"
                            Title="Select view"
                            Style="{StaticResource ModernPicker}"
                            TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}">
                        <Picker.Items>
                            <x:String>Match-by-Match</x:String>
                            <x:String>Team Averages</x:String>
                        </Picker.Items>
                    </Picker>
                </VerticalStackLayout>
            </Border>

            <!-- Graph Type Selector - BEFORE Generate Button -->
            <Border Style="{StaticResource CompactGlassCard}"
                    Margin="0,0,0,10"
                    Padding="15"
                    BackgroundColor="{AppThemeBinding Light={StaticResource LightSurfaceVariant}, Dark={StaticResource DarkSurfaceVariant}}">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Select Graph Types (Multiple)"
                           FontSize="14"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                    
                    <!-- All graph types (checkboxes) with conditional visibility -->
                    <VerticalStackLayout Spacing="8">
                        <!-- Line Chart - Both modes -->
                        <HorizontalStackLayout Spacing="10" IsVisible="{Binding ShowLineChart}">
                            <CheckBox IsChecked="{Binding IsLineSelected}" Color="{StaticResource Primary}" />
                            <Label Text="Line Chart (Trends)" 
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                        </HorizontalStackLayout>
                        
                        <!-- Bar Chart - Averages only -->
                        <HorizontalStackLayout Spacing="10" IsVisible="{Binding ShowBarChart}">
                            <CheckBox IsChecked="{Binding IsBarSelected}" Color="{StaticResource Primary}" />
                            <Label Text="Bar Chart (Team Comparison)" 
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                        </HorizontalStackLayout>
                        
                        <!-- Radar Chart - Averages only -->
                        <HorizontalStackLayout Spacing="10" IsVisible="{Binding ShowRadarChart}">
                            <CheckBox IsChecked="{Binding IsRadarSelected}" Color="{StaticResource Primary}" />
                            <Label Text="Radar Chart (Multi-dimensional)" 
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                        </HorizontalStackLayout>
                        
                        <!-- Scatter Plot - Averages only (team distribution) -->
                        <HorizontalStackLayout Spacing="10" IsVisible="{Binding ShowScatterChart}">
                            <CheckBox IsChecked="{Binding IsScatterSelected}" Color="{StaticResource Primary}" />
                            <Label Text="Scatter Plot (Team Distribution)" 
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                        </HorizontalStackLayout>
                        
                        
                        
                        <!-- Sunburst - Averages only -->
                        <HorizontalStackLayout Spacing="10" IsVisible="{Binding ShowSunburstChart}">
                            <CheckBox IsChecked="{Binding IsSunburstSelected}" Color="{StaticResource Primary}" />
                            <Label Text="Sunburst (Hierarchical)" 
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                        </HorizontalStackLayout>
                        <!-- Violin - Averages only -->
                        <HorizontalStackLayout Spacing="10" IsVisible="{Binding ShowViolinChart}">
                            <CheckBox IsChecked="{Binding IsViolinSelected}" Color="{StaticResource Primary}" />
                            <Label Text="Violin Plot (Distribution)"
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                        </HorizontalStackLayout>
                        <!-- Waterfall - Averages only -->
                        <HorizontalStackLayout Spacing="10" IsVisible="{Binding ShowWaterfallChart}">
                            <CheckBox IsChecked="{Binding IsWaterfallSelected}" Color="{StaticResource Primary}" />
                            <Label Text="Waterfall (Cascade)" 
                                   VerticalOptions="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                    
                    <Label Text="Graph types shown depend on selected view mode"
                           FontSize="11"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                           HorizontalTextAlignment="Center"
                           FontAttributes="Italic" />
                </VerticalStackLayout>
            </Border>

            <!-- Generate Button -->
            <Button Text="Generate Comparison Graphs"
                    Command="{Binding GenerateGraphsCommand}"
                    Style="{StaticResource PrimaryGlassButton}"
                    IsEnabled="{Binding IsLoading, Converter={StaticResource InvertedBoolConverter}}"
                    HeightRequest="50"
                    FontSize="16"
                    FontAttributes="Bold" />

            <!-- Graph Display -->
            <Border Style="{StaticResource ElevatedGlassCard}"
                    IsVisible="{Binding HasGraphData}"
                    BackgroundColor="{AppThemeBinding Light={StaticResource GlassOverlayLight}, Dark={StaticResource GlassOverlayDark}}">
                <VerticalStackLayout Spacing="15">
                    <Label Text="Comparison Results"
                           FontSize="20"
                           FontAttributes="Bold"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />

                    <!-- Server Graph Image (when online and available) -->
                    <Border Style="{StaticResource ElevatedGlassCard}"
                           IsVisible="{Binding UseServerImage}"
                           BackgroundColor="{AppThemeBinding Light={StaticResource GlassOverlayLight}, Dark={StaticResource GlassOverlayDark}}"
                           Padding="10"
                           Margin="0,0,0,10">
                        <VerticalStackLayout Spacing="10">
                            <Label Text="📊 Server-Generated Graph"
                                   FontSize="14"
                                   FontAttributes="Italic"
                                   HorizontalTextAlignment="Center"
                                   TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}" />
                            
                            <Image Source="{Binding ServerGraphImage}"
                                   Aspect="AspectFit"
                                   HeightRequest="400"
                                   HorizontalOptions="FillAndExpand" />
                        </VerticalStackLayout>
                    </Border>

                    <!-- Team Comparison Summary - ALWAYS VISIBLE -->
                    <CollectionView ItemsSource="{Binding ComparisonData.Teams}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:TeamComparisonData">
                                <Border Style="{StaticResource CardBorderStyle}"
                                        Margin="0,5"
                                        Padding="15">
                                    <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="15">
                                        <BoxView Grid.Column="0"
                                                WidthRequest="4"
                                                HeightRequest="40"
                                                Color="{Binding Color}"
                                                CornerRadius="2"
                                                VerticalOptions="Center" />
                                        
                                        <VerticalStackLayout Grid.Column="1" VerticalOptions="Center">
                                            <Label Text="{Binding TeamName, StringFormat='#{0}'}"
                                                   FontSize="14"
                                                   FontAttributes="Bold"
                                                   TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                                            <Label Text="{Binding MatchCount, StringFormat='{0} matches'}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}" />
                                        </VerticalStackLayout>
                                        
                                        <VerticalStackLayout Grid.Column="2" HorizontalOptions="End" VerticalOptions="Center">
                                            <Label Text="{Binding Value, StringFormat='{0:F1}'}"
                                                   FontSize="20"
                                                   FontAttributes="Bold"
                                                   TextColor="{StaticResource Primary}"
                                                   HorizontalTextAlignment="End" />
                                            <Label Text="{Binding StdDev, StringFormat='±{0:F1}'}"
                                                   FontSize="12"
                                                   TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                                                   HorizontalTextAlignment="End" />
                                        </VerticalStackLayout>
                                    </Grid>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <!-- Local Microcharts UI removed; Plotly WebView used for interactive graphs -->

                    <!-- Multiple Plotly WebViews for selected graph types -->
                    <CollectionView ItemsSource="{Binding PlotlyHtmlGraphs}"
                                   IsVisible="{Binding UsePlotlyWebView}">
                        <CollectionView.ItemTemplate>
                            <DataTemplate x:DataType="models:GraphHtmlInfo">
                                <Border Style="{StaticResource ElevatedGlassCard}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource GlassOverlayLight}, Dark={StaticResource GlassOverlayDark}}"
                                        Padding="10"
                                        Margin="0,0,0,15">
                                    <VerticalStackLayout Spacing="10">
                                        <Label Text="{Binding DisplayName}"
                                               FontSize="16"
                                               FontAttributes="Bold"
                                               HorizontalTextAlignment="Center"
                                               TextColor="{AppThemeBinding Light={StaticResource LightTextPrimary}, Dark={StaticResource DarkTextPrimary}}" />
                                        <Border HeightRequest="480"
                                                BackgroundColor="{AppThemeBinding Light={StaticResource GlassOverlayLight}, Dark={StaticResource DarkSurfaceVariant}}">
                                            <Border.StrokeShape>
                                                <RoundRectangle CornerRadius="10" />
                                            </Border.StrokeShape>
                                            <WebView Source="{Binding WebViewSource}" HeightRequest="460" />
                                        </Border>
                                    </VerticalStackLayout>
                                </Border>
                            </DataTemplate>
                        </CollectionView.ItemTemplate>
                    </CollectionView>

                    <Label Text="{Binding SelectedMetric.Name, StringFormat='Metric: {0}'}"
                           FontSize="12"
                           TextColor="{AppThemeBinding Light={StaticResource LightTextSecondary}, Dark={StaticResource DarkTextSecondary}}"
                           HorizontalTextAlignment="Center"
                           FontAttributes="Italic" />
                </VerticalStackLayout>
            </Border>

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
